#!/bin/bash
# whisper-toggle-setup — interactive setup for whisper-toggle
# Detects GPU, downloads model, configures keybinding, writes config
# License: MIT

set -euo pipefail

CONF_DIR="${XDG_CONFIG_HOME:-$HOME/.config}/whisper-toggle"
DATA_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/whisper-toggle"
MODEL_DIR="$DATA_DIR/models"
CONF_FILE="$CONF_DIR/whisper-toggle.conf"

# --- Defaults ---
BACKEND="server"
WHISPER_MODEL=""
WHISPER_PORT=58080
WHISPER_DEVICE=0
WHISPER_THREADS=4
WHISPER_LANGUAGE="en"
AUTOPASTE=1
SILENCE_DURATION=3.0
SILENCE_THRESHOLD=3
WHISPER_SERVER=""
WHISPER_CLI=""

# Common locations for whisper.cpp binaries
SEARCH_DIRS=(
    "$HOME/whisper.cpp/build/bin"
    "$HOME/.local/bin"
    "/usr/local/bin"
    "/usr/bin"
)

# --- Colors ---
BOLD='\033[1m'
DIM='\033[2m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
RED='\033[0;31m'
NC='\033[0m'

header() {
    echo ""
    echo -e "${BOLD}${CYAN}=== $1 ===${NC}"
    echo ""
}

info() { echo -e "${GREEN}>>>${NC} $*"; }
warn() { echo -e "${YELLOW}>>>${NC} $*"; }
err()  { echo -e "${RED}>>>${NC} $*"; }

prompt_choice() {
    local prompt="$1"
    shift
    local options=("$@")
    local i
    for i in "${!options[@]}"; do
        echo -e "  ${BOLD}$((i+1)))${NC} ${options[$i]}"
    done
    echo ""
    while true; do
        read -rp "$prompt [1-${#options[@]}]: " choice
        if [[ "$choice" =~ ^[0-9]+$ ]] && (( choice >= 1 && choice <= ${#options[@]} )); then
            return $((choice - 1))
        fi
        echo "  Invalid choice, try again."
    done
}

# ============================================================
# GPU DETECTION
# ============================================================
detect_gpu() {
    header "GPU Detection"

    if ! command -v lspci &>/dev/null; then
        warn "lspci not found (install pciutils for GPU detection)"
        warn "Defaulting to CPU-only (device = -1)"
        WHISPER_DEVICE=-1
        return
    fi

    local gpus=()
    local gpu_types=()
    while IFS= read -r line; do
        gpus+=("$line")
        if echo "$line" | grep -qi "nvidia\|amd\|radeon\|intel"; then
            if echo "$line" | grep -qi "nvidia"; then
                gpu_types+=("nvidia")
            elif echo "$line" | grep -qi "amd\|radeon"; then
                gpu_types+=("amd")
            else
                gpu_types+=("intel")
            fi
        else
            gpu_types+=("unknown")
        fi
    done < <(lspci 2>/dev/null | grep -iE 'VGA|3D|Display')

    if (( ${#gpus[@]} == 0 )); then
        warn "No GPUs detected"
        warn "Defaulting to CPU-only (device = -1)"
        WHISPER_DEVICE=-1
        return
    fi

    info "Detected GPU(s):"
    local i
    for i in "${!gpus[@]}"; do
        echo -e "  ${BOLD}$i)${NC} ${gpus[$i]}"
    done
    echo ""

    # Suggest discrete GPU over integrated
    local suggested=0
    for i in "${!gpu_types[@]}"; do
        if [[ "${gpu_types[$i]}" == "nvidia" || "${gpu_types[$i]}" == "amd" ]]; then
            suggested=$i
            break
        fi
    done

    echo -e "  Suggested: device ${BOLD}$suggested${NC} (${gpus[$suggested]})"
    echo ""
    read -rp "GPU device index [$suggested, or -1 for CPU-only]: " gpu_input
    if [[ -n "$gpu_input" ]]; then
        WHISPER_DEVICE="$gpu_input"
    else
        WHISPER_DEVICE="$suggested"
    fi
    info "Using device: $WHISPER_DEVICE"
}

# ============================================================
# THREAD DETECTION
# ============================================================
detect_threads() {
    local cores
    cores=$(getconf _NPROCESSORS_ONLN 2>/dev/null || echo 4)
    WHISPER_THREADS=$(( cores / 2 ))
    (( WHISPER_THREADS < 1 )) && WHISPER_THREADS=1
    info "CPU cores: $cores, using $WHISPER_THREADS threads"
}

# ============================================================
# MODEL DOWNLOAD
# ============================================================
select_model() {
    header "Model Selection"

    local names=(
        "tiny.en"
        "base.en"
        "small.en"
        "medium.en"
        "large-v3-turbo"
        "large-v3"
    )
    local sizes=(
        "75 MB"
        "142 MB"
        "466 MB"
        "1.5 GB"
        "1.6 GB"
        "3.1 GB"
    )
    local files=(
        "ggml-tiny.en.bin"
        "ggml-base.en.bin"
        "ggml-small.en.bin"
        "ggml-medium.en.bin"
        "ggml-large-v3-turbo.bin"
        "ggml-large-v3.bin"
    )
    local urls=(
        "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.en.bin"
        "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.en.bin"
        "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-small.en.bin"
        "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-medium.en.bin"
        "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-large-v3-turbo.bin"
        "https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-large-v3.bin"
    )

    echo "Available models:"
    echo ""
    local i
    for i in "${!names[@]}"; do
        local marker=""
        if [[ -f "$MODEL_DIR/${files[$i]}" ]]; then
            marker=" ${GREEN}(downloaded)${NC}"
        fi
        printf "  ${BOLD}%d)${NC} %-22s %10s%b\n" "$((i+1))" "${names[$i]}" "${sizes[$i]}" "$marker"
    done
    echo ""
    echo -e "  ${DIM}Recommended: small.en (good balance of speed and accuracy)${NC}"
    echo ""

    local choice
    while true; do
        read -rp "Select model [1-${#names[@]}]: " choice
        if [[ "$choice" =~ ^[0-9]+$ ]] && (( choice >= 1 && choice <= ${#names[@]} )); then
            choice=$((choice - 1))
            break
        fi
        echo "  Invalid choice."
    done

    local model_file="${files[$choice]}"
    local model_path="$MODEL_DIR/$model_file"
    WHISPER_MODEL="$model_path"

    if [[ -f "$model_path" ]]; then
        info "Model already downloaded: $model_path"
    else
        info "Downloading ${names[$choice]} (${sizes[$choice]})..."
        mkdir -p "$MODEL_DIR"
        if curl -L --progress-bar -o "$model_path" "${urls[$choice]}"; then
            info "Downloaded to $model_path"
        else
            err "Download failed"
            rm -f "$model_path"
            exit 1
        fi
    fi
}

# ============================================================
# BACKEND DETECTION
# ============================================================
select_backend() {
    header "Backend Selection"

    # Search PATH and common build locations
    local has_server=0
    local has_cli=0

    WHISPER_SERVER="$(command -v whisper-server 2>/dev/null || true)"
    WHISPER_CLI="$(command -v whisper-cli 2>/dev/null || true)"

    if [[ -z "$WHISPER_SERVER" ]]; then
        for dir in "${SEARCH_DIRS[@]}"; do
            if [[ -x "$dir/whisper-server" ]]; then
                WHISPER_SERVER="$dir/whisper-server"
                info "Found whisper-server at $WHISPER_SERVER"
                break
            fi
        done
    fi
    if [[ -z "$WHISPER_CLI" ]]; then
        for dir in "${SEARCH_DIRS[@]}"; do
            if [[ -x "$dir/whisper-cli" ]]; then
                WHISPER_CLI="$dir/whisper-cli"
                info "Found whisper-cli at $WHISPER_CLI"
                break
            fi
        done
    fi

    [[ -n "$WHISPER_SERVER" ]] && has_server=1
    [[ -n "$WHISPER_CLI" ]] && has_cli=1

    if (( has_server && has_cli )); then
        info "Both whisper-server and whisper-cli are available"
        echo ""
        local options=(
            "server — starts on demand, model loads while you speak (recommended)"
            "cli    — simpler, runs whisper-cli directly"
        )
        prompt_choice "Select backend" "${options[@]}"
        local idx=$?
        if (( idx == 0 )); then
            BACKEND="server"
        else
            BACKEND="cli"
        fi
    elif (( has_server )); then
        info "Found whisper-server, using server backend"
        BACKEND="server"
    elif (( has_cli )); then
        info "Found whisper-cli, using cli backend"
        BACKEND="cli"
    else
        warn "Neither whisper-server nor whisper-cli found in PATH"
        echo ""

        # Detect GPU type from earlier detection for smart default
        local aur_default=4  # CPU-only
        if (( WHISPER_DEVICE >= 0 )); then
            local gpu_info
            gpu_info=$(lspci 2>/dev/null | grep -iE 'VGA|3D|Display' | sed -n "$((WHISPER_DEVICE + 1))p")
            if echo "$gpu_info" | grep -qi nvidia; then
                aur_default=1
            elif echo "$gpu_info" | grep -qi "amd\|radeon"; then
                aur_default=2
            fi
        fi

        # Detect available AUR helper
        local aur_helper=""
        for helper in yay paru; do
            if command -v "$helper" &>/dev/null; then
                aur_helper="$helper"
                break
            fi
        done

        local options=(
            "whisper.cpp-cuda    — NVIDIA GPU"
            "whisper.cpp-hip     — AMD GPU (ROCm)"
            "whisper.cpp-vulkan  — Vulkan (portable GPU)"
            "whisper.cpp         — CPU-only"
        )

        echo "  Select a whisper.cpp package to install:"
        echo ""
        local i
        for i in "${!options[@]}"; do
            local marker=""
            if (( i + 1 == aur_default )); then
                marker=" ${GREEN}(recommended for your GPU)${NC}"
            fi
            echo -e "  ${BOLD}$((i+1)))${NC} ${options[$i]}${marker}"
        done
        echo -e "  ${BOLD}5)${NC} Skip — I'll install manually"
        echo ""

        local pkg_names=("whisper.cpp-cuda" "whisper.cpp-hip" "whisper.cpp-vulkan" "whisper.cpp")
        local choice
        while true; do
            read -rp "Select [1-5]: " choice
            if [[ "$choice" =~ ^[1-5]$ ]]; then
                break
            fi
            echo "  Invalid choice."
        done

        if (( choice <= 4 )); then
            local pkg="${pkg_names[$((choice - 1))]}"
            if [[ -n "$aur_helper" ]]; then
                info "Installing $pkg via $aur_helper..."
                if "$aur_helper" -S --needed "$pkg"; then
                    info "$pkg installed"
                    # Re-check binaries
                    command -v whisper-server &>/dev/null && has_server=1
                    command -v whisper-cli &>/dev/null && has_cli=1
                else
                    err "Installation failed — install manually and re-run setup"
                fi
            else
                warn "No AUR helper found (yay, paru)"
                echo "  Install one first, then run:"
                echo "    yay -S $pkg"
                echo ""
                echo "  Or build from source:"
                echo "    git clone https://github.com/ggerganov/whisper.cpp"
                echo "    cd whisper.cpp && cmake -B build -DGGML_CUDA=ON && cmake --build build -j"
                echo "    sudo cp build/bin/whisper-{server,cli} /usr/local/bin/"
            fi
        else
            warn "Skipping — install whisper.cpp and re-run setup"
        fi

        # Pick backend from whatever is now available
        if (( has_server )); then
            BACKEND="server"
        elif (( has_cli )); then
            BACKEND="cli"
        else
            BACKEND="server"
        fi
    fi
    info "Backend: $BACKEND"
}

# ============================================================
# LANGUAGE SELECTION
# ============================================================
select_language() {
    header "Language"
    echo "  Common options: en, de, fr, es, it, pt, zh, ja, ko, auto"
    echo ""
    read -rp "Language [en]: " lang_input
    WHISPER_LANGUAGE="${lang_input:-en}"
    info "Language: $WHISPER_LANGUAGE"
}

# ============================================================
# KEYBINDING SETUP
# ============================================================
setup_keybinding() {
    header "Keybinding Setup"

    read -rp "Configure a keybinding now? [Y/n]: " do_kb
    if [[ "${do_kb,,}" == "n" ]]; then
        return
    fi

    read -rp "Key combination [Super+\`]: " key_input
    local key="${key_input:-Super+\`}"

    # Detect WM/DE
    local wm=""
    if pgrep -x i3 &>/dev/null; then wm="i3"
    elif pgrep -x sway &>/dev/null; then wm="sway"
    elif pgrep -x Hyprland &>/dev/null; then wm="hyprland"
    elif [[ "${XDG_CURRENT_DESKTOP:-}" == *GNOME* ]]; then wm="gnome"
    elif [[ "${XDG_CURRENT_DESKTOP:-}" == *KDE* ]]; then wm="kde"
    fi

    if [[ -z "$wm" ]]; then
        warn "Could not detect window manager"
        echo "  Add this to your WM config manually:"
        echo "    Bind '$key' to: whisper-toggle"
        return
    fi

    info "Detected: $wm"

    # Convert key for each WM
    local mod='$mod'
    local wm_key="grave"

    # Parse the key combo
    if [[ "$key" == *"Super+"* || "$key" == *"Mod4+"* ]]; then
        mod='$mod'
        wm_key="${key##*+}"
    fi
    # Map backtick
    [[ "$wm_key" == '`' ]] && wm_key="grave"

    case "$wm" in
        i3)
            # Check both common i3 config locations
            local i3_conf=""
            if [[ -f "$HOME/.i3/config" ]]; then
                i3_conf="$HOME/.i3/config"
            elif [[ -f "${XDG_CONFIG_HOME:-$HOME/.config}/i3/config" ]]; then
                i3_conf="${XDG_CONFIG_HOME:-$HOME/.config}/i3/config"
            else
                warn "No i3 config found at ~/.i3/config or ~/.config/i3/config"
                echo "  Create one first, or add this binding manually:"
                echo "    bindsym ${mod}+${wm_key} exec --no-startup-id whisper-toggle"
                break
            fi
            local binding="bindsym ${mod}+${wm_key} exec --no-startup-id whisper-toggle"
            echo ""
            echo "  Add to $i3_conf:"
            echo -e "    ${BOLD}${binding}${NC}"
            echo ""
            read -rp "  Append automatically? [Y/n]: " auto
            if [[ "${auto,,}" != "n" ]]; then
                echo "" >> "$i3_conf"
                echo "# whisper-toggle speech-to-text" >> "$i3_conf"
                echo "$binding" >> "$i3_conf"
                info "Added to $i3_conf (reload i3 to apply)"
            fi
            ;;
        sway)
            local sway_conf="${XDG_CONFIG_HOME:-$HOME/.config}/sway/config"
            local binding="bindsym ${mod}+${wm_key} exec whisper-toggle"
            echo ""
            echo "  Add to $sway_conf:"
            echo -e "    ${BOLD}${binding}${NC}"
            echo ""
            read -rp "  Append automatically? [Y/n]: " auto
            if [[ "${auto,,}" != "n" ]]; then
                echo "" >> "$sway_conf"
                echo "# whisper-toggle speech-to-text" >> "$sway_conf"
                echo "$binding" >> "$sway_conf"
                info "Added to $sway_conf (reload sway to apply)"
            fi
            ;;
        hyprland)
            local hypr_conf="${XDG_CONFIG_HOME:-$HOME/.config}/hypr/hyprland.conf"
            local mainmod='$mainMod'
            local binding="bind = ${mainmod}, ${wm_key}, exec, whisper-toggle"
            echo ""
            echo "  Add to $hypr_conf:"
            echo -e "    ${BOLD}${binding}${NC}"
            echo ""
            read -rp "  Append automatically? [Y/n]: " auto
            if [[ "${auto,,}" != "n" ]]; then
                echo "" >> "$hypr_conf"
                echo "# whisper-toggle speech-to-text" >> "$hypr_conf"
                echo "$binding" >> "$hypr_conf"
                info "Added to $hypr_conf (reload Hyprland to apply)"
            fi
            ;;
        gnome)
            echo ""
            echo "  Setting custom GNOME keybinding..."
            local path="/org/gnome/settings-daemon/plugins/media-keys/custom-keybindings/whisper-toggle/"
            gsettings set org.gnome.settings-daemon.plugins.media-keys custom-bindings \
                "['$path']" 2>/dev/null || true
            dconf write "${path}name" "'Whisper Toggle'" 2>/dev/null || true
            dconf write "${path}command" "'whisper-toggle'" 2>/dev/null || true
            dconf write "${path}binding" "'<Super>grave'" 2>/dev/null || true
            info "GNOME keybinding set (check Settings > Keyboard > Custom Shortcuts)"
            ;;
        kde)
            echo ""
            echo "  KDE keybinding setup:"
            echo "    1. Open System Settings > Shortcuts > Custom Shortcuts"
            echo "    2. Add a new Global Shortcut > Command/URL"
            echo "    3. Set the trigger to: $key"
            echo "    4. Set the action to: whisper-toggle"
            ;;
    esac
}

# ============================================================
# WRITE CONFIG
# ============================================================
write_config() {
    header "Writing Configuration"

    mkdir -p "$CONF_DIR"

    cat > "$CONF_FILE" << EOF
# whisper-toggle configuration
# Generated by whisper-toggle-setup

# Backend: "server" (whisper-server, started on demand) or "cli" (whisper-cli)
BACKEND="$BACKEND"

# Path to whisper-server binary (leave empty to auto-detect)
WHISPER_SERVER="$WHISPER_SERVER"

# Path to whisper-cli binary (leave empty to auto-detect)
WHISPER_CLI="$WHISPER_CLI"

# Path to whisper model file
WHISPER_MODEL="$WHISPER_MODEL"

# Port for whisper-server backend
WHISPER_PORT=$WHISPER_PORT

# GPU device index (-1 for CPU-only)
WHISPER_DEVICE=$WHISPER_DEVICE

# Number of CPU threads for inference
WHISPER_THREADS=$WHISPER_THREADS

# Language for transcription (en, de, fr, etc. or "auto")
WHISPER_LANGUAGE="$WHISPER_LANGUAGE"

# Automatically paste transcription at cursor (1=yes, 0=no)
AUTOPASTE=$AUTOPASTE

# Silence duration (seconds) before recording auto-stops
SILENCE_DURATION=$SILENCE_DURATION

# Silence threshold percentage
SILENCE_THRESHOLD=$SILENCE_THRESHOLD
EOF

    info "Config written to $CONF_FILE"
}

# ============================================================
# MAIN
# ============================================================
echo ""
echo -e "${BOLD}whisper-toggle setup${NC}"
echo -e "${DIM}Press once to record, press again to transcribe and paste${NC}"

detect_gpu
detect_threads
select_model
select_backend
select_language
setup_keybinding
write_config

header "Setup Complete"
info "Config: $CONF_FILE"
info "Model:  $WHISPER_MODEL"
info "Run 'whisper-toggle' to test (or use your keybinding)"
echo ""
